version: "3.9"

services:
  aiogames:
    build: 
      context: .
      dockerfile: Dockerfile.prod
    container_name: aiogames-app
    user: "0:0"  # Run as root to handle permissions
    ports:
      - "${PORT:-3001}:3000"
      - "6801:6800"   # Aria2 RPC
      - "8081:8080"   # qBittorrent WebUI
      - "3129:3128"   # JDownloader API
    volumes:
      - aiogames_data:/app/data
      - downloads_data:/app/downloads
      - config_data:/app/config
      - logs_data:/app/logs
    environment:
      - NODE_ENV=production
      - DOCKER_ENV=true
      - PORT=${PORT:-3000}
      - JWT_SECRET=${JWT_SECRET}
      - MONGODB_URI=${MONGODB_URI}
      - ARIA2_URL=http://localhost:6800/jsonrpc
      - ARIA2_SECRET=${ARIA2_SECRET}
      - QBITTORRENT_URL=http://localhost:8080
      - QB_USERNAME=${QB_USERNAME}
      - QB_PASSWORD=${QB_PASSWORD}
      - JD_API_URL=http://localhost:3128/jd
      - JD_EMAIL=${JD_EMAIL}
      - JD_PASSWORD=${JD_PASSWORD}
      - STEAM_API_KEY=${STEAM_API_KEY}
      - RATE_LIMIT_REQUESTS=${RATE_LIMIT_REQUESTS:-100}
      - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW:-900000}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - aiogames-network

networks:
  aiogames-network:
    driver: bridge

volumes:
  aiogames_data:
  downloads_data:
  config_data:
  logs_data:
